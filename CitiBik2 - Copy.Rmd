---
title: "CitiBike"
author: "Derek"
date: "2/17/2018"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#4 How does weather impact ridership?
####Reading the data
```{r}
library(geosphere)
df_names=c("201601-citibike-tripdata.csv","201602-citibike-tripdata.csv","201603-citibike-tripdata.csv","201604-citibike-tripdata.csv","201605-citibike-tripdata.csv","201606-citibike-tripdata.csv","201607-citibike-tripdata.csv","201608-citibike-tripdata.csv","201609-citibike-tripdata.csv")
ride=data.frame()
for (i in df_names){
  ride=rbind(ride,read.csv(i))
}
weather=read.csv('weather_data.csv')
```
####Extract features
#####A new column called distance is generated by calculating the straight-line distance between the coordinates of the starting station and ending station. Rider gender is converted and formatted as a factor, withe levels including unkown, male, female. Therer is also an age column, generated by substrating the user's birth year from 2016. Users are seperated to four age groups (0~20:Teens, 20~40:Young Professionals, 40~60:Middle-Aged, and above 60:Seniors). Rows containing N/A are removed, and tripduration longer than 24 hours is ignored because the data might be an outlier.
```{r}
ride$distance <- distHaversine(ride[ ,c("start.station.longitude", "start.station.latitude")],ride[ ,c("end.station.longitude", "end.station.latitude")])
ride$gender=factor(ride$gender,levels=c(0,1,2),labels=c("unkown","male","female"))
ride$date=factor(format(strptime(ride$starttime,format = "%m/%d/%Y %H:%M"),"%m/%d/%Y"))
ride$age=2016-ride$birth.year
ride$agegroup=cut(ride$age, 
                       breaks = c(-Inf, 20, 30, 60,Inf), 
                       labels = c("Teens", "Young_Professionals", "Middle_Aged", "Seniors"), 
                       right = FALSE)

ride$birth.year=NULL
ride$starttime=NULL
ride$stoptime=NULL
ride$start.station.latitude=NULL
ride$end.station.latitude=NULL
ride$start.station.longitude=NULL
ride$end.station.longitude=NULL
ride$start.station.id=NULL
ride$end.station.id=NULL
ride$bikeid=NULL
ride$DATE=ride$date
ride$date=NULL

weather$STATION=NULL
weather$STATION_NAME=NULL
weather$DATE=factor(format(strptime(weather$DATE,format = "%Y%m%d"),"%m/%d/%Y"))

ride=ride[ride$tripduration<86400,]

na.omit(weather)
na.omit(ride)

```
####Merge the bike dataframe with the weather dataframe, so each row of the ride information will have weather infomation for that date
#####I used the R merge function to do a left join
```{r}
combined_df=merge(x = ride, y = weather, by = "DATE", all.x = TRUE)
library(ggplot2)
library(dplyr)
```
####Does snow/rain impact each customer group, in terms of ride time and ride displacement?
#####First, let's plot the distribution and see if there is a clear pattern
```{r}
ggplot()+geom_point(aes(x=PRCP,y=tripduration,color='Rain Impact on Customer'),combined_df[combined_df$usertype=='Customer',])+geom_point(aes(x=PRCP,y=tripduration,color='Rain Impact on Subscriber'),combined_df[combined_df$usertype=='Subscriber',])

ggplot()+geom_point(aes(x=SNOW,y=tripduration,color='Snow Impact on Customer'),combined_df[combined_df$usertype=='Customer',])+geom_point(aes(x=SNOW,y=tripduration,color='Snow Impact on Subscriber'),combined_df[combined_df$usertype=='Subscriber',])
```
######Seems like there is less ridership when raining and snowing, this makes sense. However, the weather does not seem to affect trip duration, but the number of rides.
#####Then, let's use regression to apporximate a curve that represents the relationship between riding activity level and weather infomation
```{r}
model_customer_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[combined_df$usertype=='Customer',])
newdat_customer_snow = data.frame(SNOW = seq(min(combined_df[combined_df$usertype=='Customer',]$SNOW), max(combined_df[combined_df$usertype=='Customer',]$SNOW), length.out = 300))
newdat_customer_snow$pred = predict(model_customer_snow, newdata = newdat_customer_snow)

model_subscriber_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[combined_df$usertype=='Subscriber',])
newdat_subscriber_snow = data.frame(SNOW = seq(min(combined_df[combined_df$usertype=='Subscriber',]$SNOW), max(combined_df[combined_df$usertype=='Subscriber',]$SNOW), length.out = 300))
newdat_subscriber_snow$pred = predict(model_subscriber_snow, newdata = newdat_subscriber_snow)

ggplot()+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Customer'),newdat_customer_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Subscriber'),newdat_subscriber_snow)

model_customer_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[combined_df$usertype=='Customer',])
newdat_customer_PRCP = data.frame(PRCP = seq(min(combined_df[combined_df$usertype=='Customer',]$PRCP), max(combined_df[combined_df$usertype=='Customer',]$PRCP), length.out = 300))
newdat_customer_PRCP$pred = predict(model_customer_PRCP, newdata = newdat_customer_PRCP)

model_subscriber_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[combined_df$usertype=='Subscriber',])
newdat_subscriber_PRCP = data.frame(PRCP = seq(min(combined_df[combined_df$usertype=='Subscriber',]$PRCP), max(combined_df[combined_df$usertype=='Subscriber',]$PRCP), length.out = 300))
newdat_subscriber_PRCP$pred = predict(model_subscriber_PRCP, newdata = newdat_subscriber_PRCP)

ggplot()+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Customer'),newdat_customer_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Subscriber'),newdat_subscriber_PRCP)
```
#####There is a clear a downward trend for both customer group in snow and raining situation. Serveral observation here.
#####1) The customer group has a higher trip duration than the subscriber group, under both kind of weather
#####2) The customer group also has a steeper slope than the subscriber group, which means the customer group is more sensitive to the weather condition

####Does snow/rain impact each age group, in terms of ride time and ride displacement?
```{r}
model_Teens_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Teens'),])
newdat_Teens_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Teens'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Teens'),]$SNOW), length.out = 300))
newdat_Teens_snow$pred = predict(model_Teens_snow, newdata = newdat_Teens_snow)

model_Young_Professional_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Young_Professionals'),])
newdat_Young_Professional_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$SNOW), length.out = 300))
newdat_Young_Professional_snow$pred = predict(model_Young_Professional_snow, newdata = newdat_Young_Professional_snow)

model_Middle_Aged_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Middle_Aged'),])
newdat_Middle_Aged_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$SNOW), length.out = 300))
newdat_Middle_Aged_snow$pred = predict(model_Middle_Aged_snow, newdata = newdat_Middle_Aged_snow)

model_Seniors_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Seniors'),])
newdat_Seniors_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Seniors'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Seniors'),]$SNOW), length.out = 300))
newdat_Seniors_snow$pred = predict(model_Seniors_snow, newdata = newdat_Seniors_snow)

ggplot()+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Teens'),newdat_Teens_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Young Professionals'),newdat_Young_Professional_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Middle Aged'),newdat_Middle_Aged_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Seniors'),newdat_Seniors_snow)

model_Teens_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Teens'),])
newdat_Teens_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Teens'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Teens'),]$PRCP), length.out = 300))
newdat_Teens_PRCP$pred = predict(model_Teens_PRCP, newdata = newdat_Teens_PRCP)

model_Young_Professional_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Young_Professionals'),])
newdat_Young_Professional_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$PRCP), length.out = 300))
newdat_Young_Professional_PRCP$pred = predict(model_Young_Professional_PRCP, newdata = newdat_Young_Professional_PRCP)

model_Middle_Aged_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Middle_Aged'),])
newdat_Middle_Aged_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$PRCP), length.out = 300))
newdat_Middle_Aged_PRCP$pred = predict(model_Middle_Aged_PRCP, newdata = newdat_Middle_Aged_PRCP)

model_Seniors_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Seniors'),])
newdat_Seniors_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Seniors'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Seniors'),]$PRCP), length.out = 300))
newdat_Seniors_PRCP$pred = predict(model_Seniors_PRCP, newdata = newdat_Seniors_PRCP)

ggplot()+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Teens'),newdat_Teens_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Young Professionals'),newdat_Young_Professional_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Middle Aged'),newdat_Middle_Aged_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Seniors'),newdat_Seniors_PRCP)

```
#####From both graph, we can observe that the older customer base ofthen ride a longer time, and the Young Professionals and Seniors group are more sensitive to snowing than the Teens and Middle Aged group to snowing. The Middle Aged, Seniors, and Young Professionals are less sensitive than Teens when it compes to rain.

####Does temeprature impact each customer group, in terms of ride time and ride displacement?
```{r}
model_customer_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[combined_df$usertype=='Customer',])
newdat_customer_TMAX = data.frame(TMAX = seq(min(combined_df[combined_df$usertype=='Customer',]$TMAX), max(combined_df[combined_df$usertype=='Customer',]$TMAX), length.out = 300))
newdat_customer_TMAX$pred = predict(model_customer_TMAX, newdata = newdat_customer_TMAX)

model_subscriber_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[combined_df$usertype=='Subscriber',])
newdat_subscriber_TMAX = data.frame(TMAX = seq(min(combined_df[combined_df$usertype=='Subscriber',]$TMAX), max(combined_df[combined_df$usertype=='Subscriber',]$TMAX), length.out = 300))
newdat_subscriber_TMAX$pred = predict(model_subscriber_TMAX, newdata = newdat_subscriber_TMAX)

ggplot()+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Customer'),newdat_customer_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Subscriber'),newdat_subscriber_TMAX)
```


####Does temperature impact each age group, in terms of ride time and ride displacement?
```{r}
model_Teens_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Teens'),])
newdat_Teens_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Teens'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Teens'),]$TMAX), length.out = 300))
newdat_Teens_TMAX$pred = predict(model_Teens_TMAX, newdata = newdat_Teens_TMAX)

model_Young_Professional_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Young_Professionals'),])
newdat_Young_Professional_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$TMAX), length.out = 300))
newdat_Young_Professional_TMAX$pred = predict(model_Young_Professional_TMAX, newdata = newdat_Young_Professional_TMAX)

model_Middle_Aged_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Middle_Aged'),])
newdat_Middle_Aged_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$TMAX), length.out = 300))
newdat_Middle_Aged_TMAX$pred = predict(model_Middle_Aged_TMAX, newdata = newdat_Middle_Aged_TMAX)

model_Seniors_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Seniors'),])
newdat_Seniors_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Seniors'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Seniors'),]$TMAX), length.out = 300))
newdat_Seniors_TMAX$pred = predict(model_Seniors_TMAX, newdata = newdat_Seniors_TMAX)

ggplot()+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Teens'),newdat_Teens_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Young Professionals'),newdat_Young_Professional_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Middle Aged'),newdat_Middle_Aged_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Seniors'),newdat_Seniors_TMAX)
```
####Does temeprature impact each customer group, in terms of ride time and ride displacement?
```{r}
model_all_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df)
newdat_all_TMAX = data.frame(TMAX = seq(min(combined_df$TMAX), max(combined_df$TMAX), length.out = 300))
newdat_all_TMAX$pred = predict(model_customer_TMAX, newdata = newdat_customer_TMAX)

ggplot()+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on All'),newdat_all_TMAX)
```
