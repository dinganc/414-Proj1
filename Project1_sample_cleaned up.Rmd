---
title: "Citi Bike Data Analysis Report"
author: "TO 414 Group 7 - Dingan Chen, Natasha Desai, Michael Tang, Cassandra Wong, Yan (Lucy) Xie"
date: "3/12/2018"
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
---

![Citibike at New York City taken by Cassandra Wong ](citibike.jpg)

```{r,results="hide"}
library(tidyverse)
library(dplyr)
library(rwunderground)
library(geosphere)
library(lubridate)
library(chron)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(ggmap)

bikesample <- read.csv("bikesample5%.csv")
ride <- bikesample
```



**Our team at TO414 Consultants Group analyzed Citi Bike data from Jan 2016 to Sep 2016.**
**The following report outlines major bike ridership patterns in respect to several variables, including gender, age groups, seasons, and weather data. There are seven parts to this report: (1) Descriptive Statistics, (2) Gender Analysis, (3) Seasonal Ridership Analysis, (4) Age Analysis, (5) Bike Surplus and Shortage Analysis, (6) Weather Analysis, and (7) Summary of Key Findings**

## <span style="color:#3d6ece">Part1: Descriptive Statistics</span>

To start, we have provided some descriptive statistics below to give a general sense of who Citi Bike riders are in terms of **demographic data and ride characteristic data**.

###<span style="color:#3d6ece">Demographic Data</span>
```{r}
malecount= length(which(bikesample$gender==1)) #number of male riders
femalecount= length(which(bikesample$gender==2)) #number of female riders
malepercent= malecount/(malecount+femalecount) #proporation of male riders who use citi bike
femalepercent= femalecount/(malecount+femalecount) ##proporation of female riders who use citi bike

cat("The number of male riders is", malecount, ", and the number of female riders is", femalecount, ". With these numbers we can calculate the proportion of male riders who use CitiBikes, which is", malepercent, ", and the proportion of female riders who use CitiBikes, which is", femalepercent, ".")
#age
```

```{r}
cat("The following is information about riders' ages:")
bikesample$age <- 2016-bikesample$birth.year
summary(bikesample$age)
```

###<span style="color:#3d6ece">Ride Characteristic Data</span>
```{r}
#tripduration
cat("The following is information about the riders' trip duration in minutes:")
bikesample$minutes <- bikesample$tripduration / 60
print(summary(bikesample$minutes))

```

To develop an even stronger understanding of Citi Bike riders, we separated ages into different groups.
We have classified *riders 20 years old or under as teens, riders 21 to 30 years old as young Adults, riders 31 to 60 as adults, and riders over 61 and seniors*.
We first looked at **how trip duration varied for the different age groups**.

```{r}
#data cleaning to remove trip durations that are 0
bikesample <- bikesample[which(bikesample$tripduration > 0),]

#separating ages into different groups, specified in comments above
bikesample$ageGroup <- ifelse(bikesample$age <= 20, 1, ifelse(bikesample$age <= 30, 2, ifelse(bikesample$age <= 60, 3, 4)))

bikesample$ageGroupName <- ifelse(bikesample$ageGroup== 1, "Teens", ifelse(bikesample$ageGroup==2, "Young Adults", ifelse(bikesample$ageGroup== 3,"Adults","Seniors")))

boxplot(bikesample[bikesample$ageGroup==1,]$tripduration, bikesample[bikesample$ageGroup==2,]$tripduration, bikesample[bikesample$ageGroup==3,]$tripduration, bikesample[bikesample$ageGroup==4,]$tripduration, main = "Trip Duration", ylab = "Trip Duration (Seconds)", names = c("Teens", "Young Adults", "Adults", "Seniors"), outline=FALSE) 
```

These boxplots show that the median trip duration in seconds was the lowest for teens and the highest for seniors. From the trip duration finding across different age groups, we decided to compare trip distances for the groups. 

```{r}
bikesample$distance <- mapply(function(lon1, lat1, lon2, lat2) distm(c(lon1,lat1), c(lon2, lat2)), bikesample$start.station.longitude, bikesample$start.station.latitude, bikesample$end.station.longitude, bikesample$end.station.latitude) 
bikesample$speed <- bikesample$distance / bikesample$tripduration

boxplot(bikesample[bikesample$ageGroup==1,]$distance, bikesample[bikesample$ageGroup==2,]$distance, bikesample[bikesample$ageGroup==3,]$distance, bikesample[bikesample$ageGroup==4,]$distance, main = "Trip Distance", ylab = "Trip Distance (Meters)", names = c("Teens", "Young Adults", "Adults", "Seniors"), outline = FALSE) 
``` 

While analyzing the data provided for distance, we noticed that some distances were showing up as 0, even though the time duration was positive. This means that the start location and end location were the same, and it wasn't possible to gauge the distance that the biker had actually traveled. Consequently, we did data cleaning to remove the entries with 0. 

**These boxplots show that the trip distance in meters was the lowest for teens (which makes sense as they have the lowest trip duration as well).**
**However, although seniors had the highest trip duration, they have the second lowest trip distance.**

Thus, we have also compared speeds for the different groups. To get speed, we used the speed formula (speed = distance / time).
```{r}
#getting average speed of the trip by doing sped = distance (meters) / time (second)

boxplot(bikesample[bikesample$ageGroup==1,]$speed, bikesample[bikesample$ageGroup==2,]$speed, bikesample[bikesample$ageGroup==3,]$speed, bikesample[bikesample$ageGroup==4,]$speed,  main = "Trip Speed", ylab = "Speed (meters / second)", names = c("Teens", "Young Adults", "Adults", "Seniors"), outline = FALSE) 

cat("The following is information about teen riders' biking speed:")
summary(bikesample[bikesample$ageGroup==1,]$speed)

cat("The following is information about young adult riders' biking speed:")
summary(bikesample[bikesample$ageGroup==2,]$speed)

cat("The following is information about adult riders' biking speed:")
summary(bikesample[bikesample$ageGroup==3,]$speed)

cat("The following is information about senior riders' biking speed:")
summary(bikesample[bikesample$ageGroup==4,]$speed)
```

**The data output reveals seniors bike at lower speeds than their younger counterparts.**
**Compared to young adults, who were on average biking the fastest out of all the age groups, seniors were biking approximately 0.376 m/s slower.**
**Additionally, young adults are biking at the fastest average speed, which explains why even though they have the highest trip distance, they do not have the highest trip duration.**

We performed the same calculations to see how speed varied between males and females. The following boxplot showcases that female riders tend to bike slower than male riders. 

```{r}
# we include the zero speed in the plot
boxplot(bikesample[bikesample$gender==1,]$speed, bikesample[bikesample$gender==2,]$speed,  main = "Trip Speed by Gender", ylab = "Speed (meters / second)", names = c("Male", "Female"), outline = FALSE) 
```

Delving deeper into the data about age groups, we have created data visualizations showcasing the distances that bikers traveled separated by age, as well as the speeds that bikers traveled at separated by age, both of which can be seen in the plots below.
**The first plot shows the distances riders travel visually separated by age, and the second plot shows that the speeds riders travel at visually separated by age. Both of these plots have been modified to limit the y-axes in order to remove a handful of outliers. Seniors are clearly traveling at lower speeds than young adults.**

**Citi Bike will be able to use the speed data if it is experiencing bike safety issues to assess if user speed may be an issue, particularly for the teen demographic that goes the fastest.**

```{r}
ggplot() + geom_jitter(aes(y = bikesample$distance, x = bikesample$age, colour = bikesample$ageGroup), data = bikesample, stat="identity",show.legend=FALSE) + coord_cartesian(ylim = c(0, 13000),xlim = c(12, 100))

ggplot() + geom_jitter(aes(y = bikesample$speed, x = bikesample$age, colour = bikesample$ageGroup), data = bikesample, stat="identity",show.legend=FALSE) + coord_cartesian(ylim = c(0, 7.5),xlim = c(12, 100))

```

Next, we looked at if there were times where more people of the same age group (ex. teenagers) came out to bike compared to other times of the day.
These graphs show the different times that teens, young adults, adults, and seniors often use Citi Bike. 

```{r}
bikesample$starttime <- as.POSIXlt(bikesample$starttime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)
bikesample$stoptime <- as.POSIXlt(bikesample$stoptime, tz = "", "%m/%d/%Y %H:%M:%OS", optional = FALSE)

bikesample$month <- month(bikesample$starttime) #helps with seasons
bikesample$hour <- hour(bikesample$starttime) #helps with time of day
bikesample$hour <- ifelse((minute(bikesample$starttime) >= 16 & minute(bikesample$starttime) <= 30), bikesample$hour+0.25, bikesample$hour)
bikesample$hour <- ifelse((minute(bikesample$starttime) >= 31 & minute(bikesample$starttime) <= 45), bikesample$hour+0.5, bikesample$hour)
bikesample$hour <- ifelse((minute(bikesample$starttime) >= 46 & minute(bikesample$starttime) <= 60), bikesample$hour+0.75, bikesample$hour)

Hours <- seq(from = 0, to = 23.75, by = 0.25)
TeensHours<- numeric(length(Hours))
YoungAdultsHours<- numeric(length(Hours))
AdultsHours<- numeric(length(Hours))
SeniorsHours<- numeric(length(Hours))

for(i in 1:length(Hours)) {
  TeensHours[i] = length(which(bikesample[bikesample$ageGroup==1,]$hour == Hours[i]))
  YoungAdultsHours[i] = length(which(bikesample[bikesample$ageGroup==2,]$hour == Hours[i]))
  AdultsHours[i] = length(which(bikesample[bikesample$ageGroup==3,]$hour == Hours[i]))
  SeniorsHours[i] = length(which(bikesample[bikesample$ageGroup==4,]$hour == Hours[i]))
}


TeensHours <- as.data.frame(TeensHours)
YoungAdultsHours <- as.data.frame(YoungAdultsHours)
AdultsHours <- as.data.frame(AdultsHours)
SeniorsHours <- as.data.frame(SeniorsHours)

TeensHours <- cbind(Hours, TeensHours)
YoungAdultsHours <- cbind(Hours, YoungAdultsHours)
AdultsHours <- cbind(Hours, AdultsHours)
SeniorsHours <- cbind(Hours, SeniorsHours)

TeensHours <- ggplot(data = TeensHours, aes(x=Hours, y=TeensHours)) + geom_line() + geom_smooth()
YoungAdultsHours <- ggplot(data = YoungAdultsHours, aes(x=Hours, y=YoungAdultsHours)) + geom_line() + geom_smooth()
AdultsHours <- ggplot(data = AdultsHours, aes(x=Hours, y=AdultsHours)) + geom_line() + geom_smooth()
SeniorsHours <- ggplot(data = SeniorsHours, aes(x=Hours, y=SeniorsHours )) + geom_line() + geom_smooth()

grid.arrange(TeensHours,YoungAdultsHours, AdultsHours, SeniorsHours)
```

Lastly, we have identified the most popular stations riders went to for either starting or ending their trip for reference.
**The following map shows the top 20 stations riders go to which are primarily clusters at left-to-center Manhattan area.** This data provides insights into where people utilize Citi Bike the most and where congestion is most likely to occur. 

```{r}
#Extract the numbers of leaves and arrivals from the data set 
start_station <- as.data.frame(table(bikesample$start.station.name))
end_station <- as.data.frame(table(bikesample$end.station.name))

#Extract the location of stations from the data set and omit the repeaded lines
names_coor <- data.frame(bikesample$start.station.name,bikesample$start.station.latitude,bikesample$start.station.longitude)
deduped.names_coor <- unique(names_coor)

#Combine the data frames together and calculate the out-bike ratio
stations <- merge(start_station,end_station,by.x="Var1",by.y="Var1")
stations_coor <- merge(stations,deduped.names_coor,by.x="Var1",by.y="bikesample.start.station.name")

stations_coor$bike_avg <- (stations_coor$Freq.x+stations_coor$Freq.y)/2
popular_stations <- stations_coor[order(-stations_coor$bike_avg),][1:20,]

map1 <- get_googlemap(center = c(lon = -73.989, lat = 40.74), zoom = 13,size = c(640, 640))

#plot the selected bike stations onto the google map and displace the points' color according to the degree that the staion is running out of bikes
ggmap(map1)+geom_point(data = popular_stations , aes(x = bikesample.start.station.longitude, y = bikesample.start.station.latitude), size = 3, shape = 21,fill="#3d6ece") 
```

##<span style="color:#3d6ece">Part 2: Gender Analysis</span>

**One of the most daunting findings from the descriptive statistics is the lack of female ridership. We looked into two potential causes: safety and females choosing not to use Citi Bikes for commuting.**
Below is a chart showcasing the proportion of male to female riders. 

```{r}
slices <- c(malecount, femalecount)
lbls <- c("Male Riders", "Female Riders")
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) 
lbls <- paste(lbls,"%",sep="") 
colors= c("blue", "pink")
pie(slices,labels = lbls, col= colors ,main="Gender Breakdown of Citi Bikes")
```

```{r}
bikesample$startHours <- as.POSIXlt(bikesample$starttime, format = "%m/%d/%Y %H:%M")$hour
barplot(table(bikesample[bikesample$gender==2,]$startHours), ylab = "Number of Female Rides over an Entire Year", xlab = "Hour of Departure", col= "pink",main="Number of Monthly Female Riders by Hour of Departure")
```

The peak hours of bike usage by women are 8:00 AM and 5:00-6:00 PM, indicating that women seem to be using the bikes of commuting. 

```{r}
barplot(table(bikesample[bikesample$gender==1,]$startHours), ylab = "Number of Male Rides over an Entire Year", xlab = "Hour of Departure", col= "#3d6ece",main="Number of Monthly Male Riders by Hour of Departure")
```

The peak hours for bike usage by men are the same as women indicating that men are also using bikes for commuting. Since the bike usage by both genders are so similar with bike usage dropping off for both late into the night, time of day in regards to safety does not seem to be a major issue for why women are using the bikes less than men. However, safety of riding on busy streets may be a determinant resulting in less women choosing to use bikes in the first place. Citi Bike may want to look into creating more protected bike lanes along with releasing bike driving statistics about safety to convince more women to try the bikes. 

Next, we looked into the day of week women tend to use bikes to understand if women use the bikes primarily for commuting or for a different reason resulting in greater bike usage on the weekends. 

```{r}
bikesample$date <- as.Date(bikesample$starttime, "%m/%d/%Y %H:%M")
bikesample$Month <- format(bikesample$date,"%m")
bikesample$Month = as.numeric(as.character(bikesample$Month))
bikesample$weekday <- weekdays(as.Date(bikesample$date))
bikesample$weekday <- weekdays(as.Date(bikesample$date, "%m/%d/%y"))
bikesample$weekday <- ordered(bikesample$weekday, levels = c("Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

barplot(table(bikesample[bikesample$gender==2,]$weekday), ylab = "Number of Monthly Female Riders by Day of Week", xlab ="Day", col= "pink",main="Number of Monthly Female Citibike Riders by Day")
```
**Bike riding is highest during the five work days indicating that job commuting may be the reason women are using the bikes most.**

We then decided to check male ridership per day to see if there was a greater contrast between weekdays vs. weekends for men compared to women.

```{r}
barplot(table(bikesample[bikesample$gender==1,]$weekday), ylab = "Number of Monthly Male Riders by Day of Week", xlab ="Day", col= "#3d6ece",main="Number of Monthly Male Citibike Riders by Day")
```

This graph compared to the female graph shows a greater difference for males from weekday riding versus weekend riding. On the male graph, the gap when looking at Sunday (6000) compared to Monday (10000) is  about 4000. The difference when looking at the female rider graph at Sunday (2500) compared to Monday (3000) is about 500. **This reveals the possibility that overall there are more male riders who are choosing bike transportation for commuting as opposed women. Women may be looking into other transportation options.**

**Consequently, Citi Bike may want to consider highlighting more pros of their bike service that appeal to women to help steal share from other transportation options.**

In the section below, we used the proportion of male:female to figure out where Citi Bike could advertise its bikes more. We looked into the top 10% and bottom 10% of stations in terms of male to female ratios. On the map, the red circles represent stations where there are at least 40% female ridership and the blue circles where there at least 80% ridership. In the red circle areas there is some reason women are riding bikes more.
**Citi Bike could take advantage of that fact by doing targeting marketing to try to acquire even more women there since other women will see that women already tend to use the bikes a lot in that area. The same could be done for the male dominated stations. The geographic area to target women is predominantly around the Brooklyn area and for the men is Northern New York with more specific areas identified in the map below.**

```{r}
bikesgender = data.frame(bikesample$start.station.id,bikesample$start.station.latitude, bikesample$start.station.longitude, bikesample$gender)

bikesgender$bikesample.gender[bikesgender$bikesample.gender==0] = NA
bikesgender$bikesample.gender[bikesgender$bikesample.gender==1] = "Male"
bikesgender$bikesample.gender[bikesgender$bikesample.gender==2] = "Female"

bikesgender_clean = subset(bikesgender, is.na(bikesgender$bikesample.gender) != TRUE)
bikesgender_clean$count = (bikesgender_clean$bikesample.gender == "Male")


count_clean = tapply(bikesgender_clean$count, bikesgender_clean$bikesample.start.station.id, mean)


gender_station_male = count_clean[count_clean>0.84]
y = bikesgender[bikesgender$bikesample.start.station.id %in% names(gender_station_male),]

gender_station_female = count_clean[count_clean<0.60]
test_stations = bikesgender[bikesgender$bikesample.start.station.id %in% names(gender_station_female),]

ggmap(map1) + geom_point(aes(y=bikesample.start.station.latitude, x =bikesample.start.station.longitude), data = y, size= 5, colour = "Blue") + scale_fill_hue(l=70, c=35) + geom_point(aes(y=bikesample.start.station.latitude, x =bikesample.start.station.longitude), data = test_stations, size=5, colour = "Red") + scale_fill_hue(l=70, c=35)

```

##<span style="color:#3d6ece">Part 3: Seasonal Ridership Analysis</span>

Additionally, we conducted seasonal analysis for number of riders. It can be seen that winter has the lowest number of bikes used. Since the bikes have already been purchased, unused bikes represent lost revenue.
**Consequently, Citi may want to consider offering greater promotions in the winter or investing in winter bike wheels to promote which could lead to more people considering bikes a viable option even in the colder months.**

**Furthermore, Fall and Summer seem to have greater bike usage so pricing higher in these seasons may help Citi make up for loses in the winter.** 

```{r}
bikesample$Season<-ifelse(bikesample$Month == 1,"Winter",
		ifelse(bikesample$Month== 2,"Winter",
		ifelse(bikesample$Month== 3,"Spring", 
		ifelse(bikesample$Month== 4,"Spring",
		ifelse(bikesample$Month== 5,"Spring",
		ifelse(bikesample$Month== 6,"Summer",
		ifelse(bikesample$Month== 7,"Summer",
		ifelse(bikesample$Month== 8,"Summer","Fall"))))))))

spring= length(which(bikesample$Season=="Spring"))/3
summer= length(which(bikesample$Season=="Summer"))/3
winter= length(which(bikesample$Season=="Winter"))/2
fall= length(which(bikesample$Season=="Fall"))

J = c(fall, winter, spring, summer)
barplot(J, main="Number of Bikes Used per Season on Average", xlab= "Season",col=c("red","darkblue", "green", "yellow"), ylab="Number of riders", names.arg = c("Fall", "Winter", "Spring", "Summer")) 
```


##<span style="color:#3d6ece">Part 4: Age Analysis</span>

In order to provide recommendations for areas to advertise based on demographic age data, we analyzed the median age at each start station.

**Through this analysis, we found that the bike stations in Northern Manhattan and Eastern Brooklyn (shown by the salmon dots) have a high young median age. The majority group of ages 30-40 and 40-50 are spread out fairly evenly across New York. Additionally, there is not a distinct elderly used station. Consequently, Citi Bike has the biggest opportunity to target the youngest demographic that distinctly lies highly in the Northern Manhattan and Eastern Brooklyn area through advertisements in those areas.** 

```{r}
bikesbyage_age = subset(bikesample, is.na(bikesample$age)!= TRUE)

bikesbyage_age_by_station = aggregate(bikesbyage_age$age, list(bikesbyage_age$start.station.name), median)

bikesbyage_coordinates_lat = aggregate(bikesbyage_age$start.station.latitude, list(bikesbyage_age$start.station.name), median)

bikesbyage_coordinates_long = aggregate(bikesbyage_age$start.station.longitude, list(bikesbyage_age$start.station.name), median)


bikesbyage_age_by_station = merge(bikesbyage_age_by_station, bikesbyage_coordinates_lat, by = "Group.1")

bikesbyage_age_by_station = merge(bikesbyage_age_by_station, bikesbyage_coordinates_long, by = 'Group.1')

names(bikesbyage_age_by_station) = c('Station_name', 'Median_age', 'Lat', 'Long')
bikesbyage_age_by_station$age_group[bikesbyage_age_by_station$Median_age <= 30] = "18-30"

bikesbyage_age_by_station$age_group[bikesbyage_age_by_station$Median_age <= 40 & bikesbyage_age_by_station$Median_age>30] = "30-40"

bikesbyage_age_by_station$age_group[bikesbyage_age_by_station$Median_age <= 50 & bikesbyage_age_by_station$Median_age>40] = "40-50"

bikesbyage_age_by_station$age_group[bikesbyage_age_by_station$Median_age <= 60 & bikesbyage_age_by_station$Median_age>50] = "50-60"

bikesbyage_age_by_station$age_group[ bikesbyage_age_by_station$Median_age>60] = "60+"


ggmap(map1) + geom_point(aes(x=Long, y=Lat, colour = age_group), data = bikesbyage_age_by_station, alpha = .7, size = .9, show.legend = TRUE)

```



##<span style="color:#3d6ece">Part 5: Bike Surplus and Shortage Analysis</span>

In order to figure out the asymmetric traffic faced by Citi Bike and make recommendations on bike additions to current stations or new station additions, we are going to look at the level of asymmetry in terms of both percentages and absolute values:

###<span style="color:#3d6ece">Assymetry in terms of percentages</span>
```{r}
#select the stations to plot
stations_coor$shortage <- stations_coor$Freq.x-stations_coor$Freq.y
stations_coor$bike_shortage_ratio =stations_coor[,7]/stations_coor[,6]
stations_coor <- stations_coor[order(stations_coor$bike_shortage_ratio),]

pct_surplus_stations <- stations_coor[1:30,]
pct_shortage_stations <- stations_coor[(nrow(stations_coor)-29):nrow(stations_coor),]
pct_selected_stations <- rbind(pct_surplus_stations,pct_shortage_stations)

#plot the google map in R
map2 <- get_googlemap(center = c(lon = -73.989, lat = 40.74), zoom = 12,size = c(640, 640))
ggmap(map2)+geom_point(data = pct_selected_stations , aes(x = bikesample.start.station.longitude, y = bikesample.start.station.latitude,fill = bike_shortage_ratio), size = 4, shape = 21,show.legend = TRUE) + scale_fill_gradient(low = "#0000FF", high = "#FF0000")
```

**The top 30 Citi Bike stations in terms of bike surplus percentage that might need to add more docks are the followings:**
```{r}
print(pct_surplus_stations[,1])
```

**The top 30 Citi Bike stations in terms of bike shortage percentage that might need to add more bikes are the followings:**
```{r}
print(pct_shortage_stations[,1])
```

**Areas in upper Manhattan and Brooklyn are demonstrating a bike shortage. Those could be areas that Citi Bike company increase bike capacity to current stations or set up new bike stations in neighboring streets.**


###<span style="color:#3d6ece">Assymetry in terms of absolute surplus and shortage</span>
```{r}
stations_coor <- stations_coor[order(stations_coor$shortage),]
stations_coor$Surplus_Shortage <- ifelse(stations_coor$shortage>0,"Shortage","Surplus")

#Top 70 stations with shortages and surpluses
abs_surplus_stations<- head(stations_coor, n=70)
abs_shortage_stations <- tail(stations_coor, n =70)
abs_selected_stations <- rbind(abs_surplus_stations, abs_shortage_stations)


ggmap(map1)+ geom_point(aes(x = bikesample.start.station.longitude, y = bikesample.start.station.latitude), colour = ifelse(abs_selected_stations$Surplus=="Surplus",'navyblue','red3'), data = abs_selected_stations, size = 3,alpha = .5, show.legend = FALSE)
```

By exploring the absolute surplus and shortage, we figured out the stations that need capacity expansion the most.

**The blue dots show the stations that are running a bike surplus and the red dots are facing a bike shortage. We can see the pattern that people in Manhattan are moving from the edge (especially the right edge) towards the center.**
**We recommend to add bikes to those current stations / set up new bike stations in neighboring streets at the edge of Manhattan and add empty docks at the left-to-center side of Manhattan.**



##<span style="color:#3d6ece">Part 6: Weather Analysis</span>

```{r}
weather=read.csv('weather_data.csv')
```

```{r, results="hide"}
####Extract features #####A new column called distance is generated by calculating the straight-line distance between the coordinates of the starting station and ending station. Rider gender is converted and formatted as a factor, withe levels including unknown, male, female. There is also an age column, generated by subtracting the user's birth year from 2016. Users are separated to four age groups (0~20:Teens, 20~30:Young Adults, 30~60:Adults, and above 60:Seniors). Rows containing N/A are removed, and tripduration longer than 24 hours is ignored because the data might be an outlier.

ride$distance <- distHaversine(ride[ ,c("start.station.longitude", "start.station.latitude")],ride[ ,c("end.station.longitude", "end.station.latitude")])
ride$gender=factor(ride$gender,levels=c(0,1,2),labels=c("unkown","male","female"))
ride$date=factor(format(strptime(ride$starttime,format = "%m/%d/%Y %H:%M"),"%m/%d/%Y"))
ride$age=2016-ride$birth.year
ride$agegroup=cut(ride$age, 
                       breaks = c(-Inf, 20, 30, 60,Inf), 
                       labels = c("Teens", "Young_Professionals", "Middle_Aged", "Seniors"), 
                       right = FALSE)

ride$birth.year=NULL
ride$starttime=NULL
ride$stoptime=NULL
ride$start.station.latitude=NULL
ride$end.station.latitude=NULL
ride$start.station.longitude=NULL
ride$end.station.longitude=NULL
ride$start.station.id=NULL
ride$end.station.id=NULL
ride$bikeid=NULL
ride$DATE=ride$date
ride$date=NULL

weather$STATION=NULL
weather$STATION_NAME=NULL
weather$DATE=factor(format(strptime(weather$DATE,format = "%Y%m%d"),"%m/%d/%Y"))

ride=ride[ride$tripduration<86400,]

na.omit(weather)
na.omit(ride)

#Merge the bike dataframe with the weather dataframe, so each row of the ride information will have weather infomation for that date 
#Used the R merge function to do a left join

combined_df=merge(x = ride, y = weather, by = "DATE", all.x = TRUE)
```

Firstly, we wanted to use the weather data to see if the weather, such as whether it was snowing or raining, impacted each customer group in terms of trip duration and distance. We plotted the distribution to see if there was a clear pattern. 

```{r}
ggplot()+geom_point(aes(x=PRCP,y=tripduration,color='Rain Impact on Customer'),combined_df[combined_df$usertype=='Customer',])+geom_point(aes(x=PRCP,y=tripduration,color='Rain Impact on Subscriber'),combined_df[combined_df$usertype=='Subscriber',])
```

```{r}
ggplot()+geom_point(aes(x=SNOW,y=tripduration,color='Snow Impact on Customer'),combined_df[combined_df$usertype=='Customer',])+geom_point(aes(x=SNOW,y=tripduration,color='Snow Impact on Subscriber'),combined_df[combined_df$usertype=='Subscriber',])
```


**These plots show that there is less ridership when it's raining or snowing, which makes sense. However, the weather does not seem to affect trip duration; just the number of rides is affected.**
We used a regression to approximate a curve that represents the relationship between riding activity levels and the weather information. 

```{r}
model_customer_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[combined_df$usertype=='Customer',])
newdat_customer_snow = data.frame(SNOW = seq(min(combined_df[combined_df$usertype=='Customer',]$SNOW), max(combined_df[combined_df$usertype=='Customer',]$SNOW), length.out = 300))
newdat_customer_snow$pred = predict(model_customer_snow, newdata = newdat_customer_snow)

model_subscriber_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[combined_df$usertype=='Subscriber',])
newdat_subscriber_snow = data.frame(SNOW = seq(min(combined_df[combined_df$usertype=='Subscriber',]$SNOW), max(combined_df[combined_df$usertype=='Subscriber',]$SNOW), length.out = 300))
newdat_subscriber_snow$pred = predict(model_subscriber_snow, newdata = newdat_subscriber_snow)

ggplot()+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Customer'),newdat_customer_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Subscriber'),newdat_subscriber_snow)
```

```{r}
model_customer_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[combined_df$usertype=='Customer',])
newdat_customer_PRCP = data.frame(PRCP = seq(min(combined_df[combined_df$usertype=='Customer',]$PRCP), max(combined_df[combined_df$usertype=='Customer',]$PRCP), length.out = 300))
newdat_customer_PRCP$pred = predict(model_customer_PRCP, newdata = newdat_customer_PRCP)

model_subscriber_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[combined_df$usertype=='Subscriber',])
newdat_subscriber_PRCP = data.frame(PRCP = seq(min(combined_df[combined_df$usertype=='Subscriber',]$PRCP), max(combined_df[combined_df$usertype=='Subscriber',]$PRCP), length.out = 300))
newdat_subscriber_PRCP$pred = predict(model_subscriber_PRCP, newdata = newdat_subscriber_PRCP)

ggplot()+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Customer'),newdat_customer_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Subscriber'),newdat_subscriber_PRCP)
```

There is a clear downward trend for both customer groups when it's snowing or raining. Several observations can be made:
**1. The customer group has a higher trip duration than the subscriber group, regardless of the rain or snow.**
**2. The customer group has a steeper slope than the subscriber group, which means that the customer group is more sensitive to weather conditions.**

With these observations in mind, we wanted to see if snow or rain impacted age groups in terms of trip durations and distances. 

```{r}
model_Teens_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Teens'),])
newdat_Teens_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Teens'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Teens'),]$SNOW), length.out = 300))
newdat_Teens_snow$pred = predict(model_Teens_snow, newdata = newdat_Teens_snow)

model_Young_Professional_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Young_Professionals'),])
newdat_Young_Professional_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$SNOW), length.out = 300))
newdat_Young_Professional_snow$pred = predict(model_Young_Professional_snow, newdata = newdat_Young_Professional_snow)

model_Middle_Aged_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Middle_Aged'),])
newdat_Middle_Aged_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$SNOW), length.out = 300))
newdat_Middle_Aged_snow$pred = predict(model_Middle_Aged_snow, newdata = newdat_Middle_Aged_snow)

model_Seniors_snow <- lm(tripduration ~ poly(SNOW,1), data=combined_df[which(combined_df$agegroup=='Seniors'),])
newdat_Seniors_snow = data.frame(SNOW = seq(min(combined_df[which(combined_df$agegroup=='Seniors'),]$SNOW), max(combined_df[which(combined_df$agegroup=='Seniors'),]$SNOW), length.out = 300))
newdat_Seniors_snow$pred = predict(model_Seniors_snow, newdata = newdat_Seniors_snow)

ggplot()+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Teens'),newdat_Teens_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Young Professionals'),newdat_Young_Professional_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Middle Aged'),newdat_Middle_Aged_snow)+geom_point(aes(x=SNOW,y=pred,color='Snow Impact on Seniors'),newdat_Seniors_snow)
```

```{r}
model_Teens_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Teens'),])
newdat_Teens_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Teens'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Teens'),]$PRCP), length.out = 300))
newdat_Teens_PRCP$pred = predict(model_Teens_PRCP, newdata = newdat_Teens_PRCP)

model_Young_Professional_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Young_Professionals'),])
newdat_Young_Professional_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$PRCP), length.out = 300))
newdat_Young_Professional_PRCP$pred = predict(model_Young_Professional_PRCP, newdata = newdat_Young_Professional_PRCP)

model_Middle_Aged_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Middle_Aged'),])
newdat_Middle_Aged_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$PRCP), length.out = 300))
newdat_Middle_Aged_PRCP$pred = predict(model_Middle_Aged_PRCP, newdata = newdat_Middle_Aged_PRCP)

model_Seniors_PRCP <- lm(tripduration ~ poly(PRCP,1), data=combined_df[which(combined_df$agegroup=='Seniors'),])
newdat_Seniors_PRCP = data.frame(PRCP = seq(min(combined_df[which(combined_df$agegroup=='Seniors'),]$PRCP), max(combined_df[which(combined_df$agegroup=='Seniors'),]$PRCP), length.out = 300))
newdat_Seniors_PRCP$pred = predict(model_Seniors_PRCP, newdata = newdat_Seniors_PRCP)

ggplot()+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Teens'),newdat_Teens_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Young Professionals'),newdat_Young_Professional_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Middle Aged'),newdat_Middle_Aged_PRCP)+geom_point(aes(x=PRCP,y=pred,color='Rain Impact on Seniors'),newdat_Seniors_PRCP)
```


**From both graphs, we can observe that the older customer base often ride for longer times, and the young adults and seniors group are more sensitive to snow than teens and middle aged riders.**
**On the other hand, the middle aged, seniors, and young adults are less sensitive than teens when it comes to rain.**

Next, we looked into whether temperature impacted each customer group, in terms of trip duration and distance. 
```{r}
model_customer_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[combined_df$usertype=='Customer',])
newdat_customer_TMAX = data.frame(TMAX = seq(min(combined_df[combined_df$usertype=='Customer',]$TMAX), max(combined_df[combined_df$usertype=='Customer',]$TMAX), length.out = 300))
newdat_customer_TMAX$pred = predict(model_customer_TMAX, newdata = newdat_customer_TMAX)

model_subscriber_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[combined_df$usertype=='Subscriber',])
newdat_subscriber_TMAX = data.frame(TMAX = seq(min(combined_df[combined_df$usertype=='Subscriber',]$TMAX), max(combined_df[combined_df$usertype=='Subscriber',]$TMAX), length.out = 300))
newdat_subscriber_TMAX$pred = predict(model_subscriber_TMAX, newdata = newdat_subscriber_TMAX)

ggplot()+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Customer'),newdat_customer_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Subscriber'),newdat_subscriber_TMAX)
```

In general, as it gets warmer, people will ride for longer times.
**On this graph, we observed that the customers group had longer trip durations than the Subscribers group, which matches our observation above.**
**With this in mind, we thought that a break down by age group might be more useful, which can be seen below.**


```{r}
model_Teens_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Teens'),])
newdat_Teens_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Teens'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Teens'),]$TMAX), length.out = 300))
newdat_Teens_TMAX$pred = predict(model_Teens_TMAX, newdata = newdat_Teens_TMAX)

model_Young_Professional_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Young_Professionals'),])
newdat_Young_Professional_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Young_Professionals'),]$TMAX), length.out = 300))
newdat_Young_Professional_TMAX$pred = predict(model_Young_Professional_TMAX, newdata = newdat_Young_Professional_TMAX)

model_Middle_Aged_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Middle_Aged'),])
newdat_Middle_Aged_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Middle_Aged'),]$TMAX), length.out = 300))
newdat_Middle_Aged_TMAX$pred = predict(model_Middle_Aged_TMAX, newdata = newdat_Middle_Aged_TMAX)

model_Seniors_TMAX <- lm(tripduration ~ poly(TMAX,2), data=combined_df[which(combined_df$agegroup=='Seniors'),])
newdat_Seniors_TMAX = data.frame(TMAX = seq(min(combined_df[which(combined_df$agegroup=='Seniors'),]$TMAX), max(combined_df[which(combined_df$agegroup=='Seniors'),]$TMAX), length.out = 300))
newdat_Seniors_TMAX$pred = predict(model_Seniors_TMAX, newdata = newdat_Seniors_TMAX)

ggplot()+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Teens'),newdat_Teens_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Young Professionals'),newdat_Young_Professional_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Middle Aged'),newdat_Middle_Aged_TMAX)+geom_point(aes(x=TMAX,y=pred,color='Temperature Impact on Seniors'),newdat_Seniors_TMAX)
```

**Across the age groups, people ride more Citi Bikes as the temperature gets warmer. However, the ridership peaks at approximately 75 degrees. Temperatures hotter than this causes a negative impact on the ride duration. Seniors still have the highest ride duration, followed by middle aged, young adults, and teens.** 

**However, the senior group's peak ridership temperature arrives sooner than middle aged, then young adults, and teens. This means the senior group has a lower temperature tolerance that causes the group to ride less with warmer temperatures. Therefore, the seniors are very sensitive to the temperature change, followed by middle aged, seniors, and teens.**


##<span style="color:#3d6ece">Part 7: Recommendations</span>

1. Citi Bike should highlight more pros of their bike service that appeal to women to help steal share from other transportation options since our data analysis indicates a lot less women choosing bikes for commuting compared to men. Furthermore, Citi Bike should look into creating more protected bike lanes along with releasing positive bike driving statistics about safety to convince more women to try bikes since a 2015 study from New York University??s Rudin Center for Transportation found that women find biking in urban streets risky in terms of safety.

2. Citi Bike should conduct targeted marketing to women around stations where there was a higher balance between male to female riders. Since women are already choosing to ride bikes more at those areas, there is a greater chance of other women seeing women are opting to bike transportation and give it a try. The same could be done for the male dominated stations. The geographic area to target women is predominantly around the Brooklyn area and for men is Northern New York with more specific areas identified in the map created in Part 3: Gender Analysis. 
3. Based on the Seasonal Ridership Analysis, Citi should consider offering greater promotions in the winter or investing in winter bike wheels to advertise which could lead to more people considering bikes a viable option even in the colder months. Furthermore, Fall and Summer seem to have greater bike usage so pricing higher in these seasons may help Citi make up for loses in the winter. Citi Bike would need to adjust their current pricing model which is subscription based for regular users to reflect the seasonality aspect of the bikes or could use the seasonal data to price differently just for the non-subscription bike riders. 

4. Citi Bike should target the youngest demographic that distinctly lies highly in Northern Manhattan and Eastern Brooklyn area through advertisements in those areas (Seen in the map of Part 4: Age Analysis).

5. Citi Bike should set up new bike stations in neighboring streets at the edge of Manhattan and add empty docks at the left-to-center side of Manhattan (More specifics in Part 5: Bike Surplus and Shortage Analysis). 

6. On days when the weather is above 75 degrees, Citi Bike should offer a promotion to customers (single user bike riders, not subscribers) in order to encourage more use of the bikes that typically get less use on hot days. 
